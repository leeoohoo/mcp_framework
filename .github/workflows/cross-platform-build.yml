# MCP Framework è·¨å¹³å°æ„å»ºå·¥ä½œæµ
# æ”¯æŒ Linuxã€Windowsã€Intel Mac å’Œ Apple Silicon Mac å››ä¸ªå¹³å°

name: Cross-Platform Build

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      server_script:
        description: 'æœåŠ¡å™¨è„šæœ¬æ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼šmy_server.pyï¼‰'
        required: true
        default: 'test_server.py'
        type: string
      build_platform:
        description: 'æ„å»ºå¹³å°'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - linux
        - windows
        - macos
        - native

env:
  PYTHON_VERSION: '3.11'
  SERVER_SCRIPT: ${{ github.event.inputs.server_script || 'test_server.py' }}

jobs:
  # æ£€æŸ¥æœåŠ¡å™¨è„šæœ¬æ˜¯å¦å­˜åœ¨
  check-script:
    runs-on: ubuntu-latest
    outputs:
      script-exists: ${{ steps.check.outputs.exists }}
      script-name: ${{ steps.check.outputs.name }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if server script exists
      id: check
      run: |
        if [ -f "${{ env.SERVER_SCRIPT }}" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "name=$(basename ${{ env.SERVER_SCRIPT }} .py)" >> $GITHUB_OUTPUT
          echo "âœ… æ‰¾åˆ°æœåŠ¡å™¨è„šæœ¬: ${{ env.SERVER_SCRIPT }}"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âŒ æœåŠ¡å™¨è„šæœ¬ä¸å­˜åœ¨: ${{ env.SERVER_SCRIPT }}"
          echo "è¯·ç¡®ä¿è„šæœ¬æ–‡ä»¶å­˜åœ¨äºé¡¹ç›®æ ¹ç›®å½•"
        fi

  # è·¨å¹³å°æ„å»ºä»»åŠ¡
  build:
    needs: check-script
    if: needs.check-script.outputs.script-exists == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            build-method: docker
            runner-arch: x64
          
          # Windows x86_64
          - os: windows-latest
            platform: windows
            arch: x86_64
            build-method: docker
            runner-arch: x64
          
          # macOS Intel x86_64
          - os: macos-13
            platform: macos
            arch: x86_64
            build-method: native
            runner-arch: x64
          
          # macOS Apple Silicon ARM64 (M1/M2/M3)
          - os: macos-latest
            platform: macos
            arch: arm64
            build-method: native
            runner-arch: arm64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # è®¾ç½® Dockerï¼ˆä»… Linux å’Œ Windows éœ€è¦ï¼‰
    - name: Set up Docker Buildx
      if: matrix.build-method == 'docker'
      uses: docker/setup-buildx-action@v3
    
    # å®‰è£… MCP Framework
    - name: Install MCP Framework
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    # å®‰è£…é¡¹ç›®ä¾èµ–
    - name: Install project dependencies
      run: |
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
      shell: bash
    
    # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    - name: Show system info
      run: |
        echo "ğŸ–¥ï¸  ç³»ç»Ÿä¿¡æ¯:"
        echo "æ“ä½œç³»ç»Ÿ: ${{ matrix.os }}"
        echo "å¹³å°: ${{ matrix.platform }}"
        echo "æ¶æ„: ${{ matrix.arch }}"
        echo "æ„å»ºæ–¹æ³•: ${{ matrix.build-method }}"
        echo "Runner æ¶æ„: ${{ matrix.runner-arch }}"
        python -c "import platform; print(f'Python å¹³å°: {platform.platform()}'); print(f'æœºå™¨æ¶æ„: {platform.machine()}'); print(f'å¤„ç†å™¨: {platform.processor()}')"
    
    # æ„å»º MCP æœåŠ¡å™¨
    - name: Build MCP Server for ${{ matrix.platform }}-${{ matrix.arch }}
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º ${{ matrix.platform }}-${{ matrix.arch }} å¹³å°..."
        
        if [ "${{ matrix.build-method }}" = "docker" ]; then
          # ä½¿ç”¨ Docker è·¨å¹³å°æ„å»º
          python -m mcp_framework.build --platform ${{ matrix.platform }} --server ${{ env.SERVER_SCRIPT }} --no-test
        else
          # ä½¿ç”¨æœ¬åœ°æ„å»ºï¼ˆmacOSï¼‰
          python -m mcp_framework.build --platform native --server ${{ env.SERVER_SCRIPT }} --no-test
        fi
      shell: bash
    
    # éªŒè¯æ„å»ºäº§ç‰©
    - name: Verify build artifacts
      run: |
        echo "ğŸ“¦ æ„å»ºäº§ç‰©åˆ—è¡¨:"
        if [ -d "dist" ]; then
          ls -la dist/
          echo ""
          echo "ğŸ“Š æ„å»ºäº§ç‰©å¤§å°:"
          du -sh dist/*
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ° dist ç›®å½•"
          exit 1
        fi
      shell: bash
    
    # æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä»… macOS æœ¬åœ°æ„å»ºï¼‰
    - name: Test executable
      if: matrix.build-method == 'native'
      run: |
        echo "ğŸ§ª æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶..."
        if [ -f "dist/${{ needs.check-script.outputs.script-name }}" ]; then
          ./dist/${{ needs.check-script.outputs.script-name }} --help
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸  å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æµ‹è¯•"
        fi
      shell: bash
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ needs.check-script.outputs.script-name }}-${{ matrix.platform }}-${{ matrix.arch }}
        path: dist/
        retention-days: 30
        compression-level: 6
    
    # æ˜¾ç¤ºæ„å»ºæ‘˜è¦
    - name: Build summary
      run: |
        echo "âœ… ${{ matrix.platform }}-${{ matrix.arch }} æ„å»ºå®Œæˆ"
        echo "ğŸ“ äº§ç‰©å·²ä¸Šä¼ ä¸º: ${{ needs.check-script.outputs.script-name }}-${{ matrix.platform }}-${{ matrix.arch }}"

  # æ„å»ºæ‘˜è¦
  build-summary:
    needs: [check-script, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Build Summary
      run: |
        echo "ğŸ¯ è·¨å¹³å°æ„å»ºæ‘˜è¦"
        echo "=================="
        echo "æœåŠ¡å™¨è„šæœ¬: ${{ env.SERVER_SCRIPT }}"
        echo "è„šæœ¬åç§°: ${{ needs.check-script.outputs.script-name }}"
        echo "æ„å»ºçŠ¶æ€: ${{ needs.build.result }}"
        echo ""
        echo "ğŸ“¦ æ”¯æŒçš„å¹³å°:"
        echo "- Linux x86_64 (Docker æ„å»º)"
        echo "- Windows x86_64 (Docker æ„å»º)"
        echo "- macOS Intel x86_64 (æœ¬åœ°æ„å»º)"
        echo "- macOS Apple Silicon ARM64 (æœ¬åœ°æ„å»º)"
        echo ""
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸï¼"
        else
          echo "âŒ éƒ¨åˆ†å¹³å°æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi

  # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releasesï¼ˆä»…æ ‡ç­¾æ¨é€æ—¶ï¼‰
  release:
    needs: [check-script, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && needs.build.result == 'success'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Prepare release files
      run: |
        echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        mkdir -p release/
        
        # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ°å‘å¸ƒç›®å½•
        find artifacts/ -name "*.tar.gz" -exec cp {} release/ \;
        find artifacts/ -name "*.zip" -exec cp {} release/ \;
        
        echo "å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
        ls -la release/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        draft: false
        prerelease: false
        body: |
          ## ğŸš€ MCP Server è·¨å¹³å°å‘å¸ƒ
          
          æ­¤ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹å¹³å°çš„æ„å»ºäº§ç‰©ï¼š
          
          ### ğŸ“± æ”¯æŒå¹³å°
          - **Linux x86_64** - é€‚ç”¨äºå¤§å¤šæ•° Linux å‘è¡Œç‰ˆ
          - **Windows x86_64** - é€‚ç”¨äº Windows 10/11
          - **macOS Intel (x86_64)** - é€‚ç”¨äº Intel èŠ¯ç‰‡çš„ Mac
          - **macOS Apple Silicon (ARM64)** - é€‚ç”¨äº M1/M2/M3 èŠ¯ç‰‡çš„ Mac
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - ä¸‹è½½å¯¹åº”æ‚¨ç³»ç»Ÿæ¶æ„çš„æ–‡ä»¶
          - è§£å‹åå³å¯ç›´æ¥è¿è¡Œ
          - è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£
          
          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - Python ç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Docker è·¨å¹³å°æ„å»ºæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  docker-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install MCP Framework
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Test Docker cross-platform builds
      run: |
        echo "ğŸ³ æµ‹è¯• Docker è·¨å¹³å°æ„å»º..."
        
        # æµ‹è¯• Linux æ„å»º
        if [ -f "${{ env.SERVER_SCRIPT }}" ]; then
          echo "æµ‹è¯• Linux æ„å»º..."
          python -m mcp_framework.build --platform linux --server ${{ env.SERVER_SCRIPT }} --no-test
          
          echo "æµ‹è¯• Windows æ„å»º..."
          python -m mcp_framework.build --platform windows --server ${{ env.SERVER_SCRIPT }} --no-test
        else
          echo "âš ï¸  æœåŠ¡å™¨è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡ Docker æµ‹è¯•"
        fi
    
    - name: Upload Docker test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: docker-cross-platform-test
        path: dist/
        retention-days: 7